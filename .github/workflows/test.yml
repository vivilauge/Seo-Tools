name: æµ‹è¯•å’ŒéªŒè¯

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: æ£€æŸ¥ä»£ç è¯­æ³•
      run: |
        echo "ðŸ” æ£€æŸ¥ server.js è¯­æ³•..."
        node -c server.js
        echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
    
    - name: æ£€æŸ¥ API serverless å‡½æ•°è¯­æ³•
      run: |
        if [ -f "api/server.js" ]; then
          echo "ðŸ” æ£€æŸ¥ api/server.js è¯­æ³•..."
          node -c api/server.js
          echo "âœ… API å‡½æ•°è¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
          echo "â„¹ï¸ api/server.js ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æŸ¥"
        fi
    
    - name: å¯åŠ¨æœåŠ¡å™¨å¹¶æµ‹è¯• API
      run: |
        echo "ðŸš€ å¯åŠ¨æœåŠ¡å™¨..."
        node server.js &
        SERVER_PID=$!
        sleep 3
        
        echo "ðŸ§ª æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨..."
        if curl -f http://localhost:3000 > /dev/null 2>&1; then
          echo "âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ"
        else
          echo "âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
          exit 1
        fi
        
        echo "ðŸ§ª æµ‹è¯• POST API /check_status..."
        RESPONSE=$(curl -s -X POST http://localhost:3000/check_status \
          -H "Content-Type: application/json" \
          -d '{"url":"example.com","protocol":"http"}' \
          -w "\nHTTP_CODE:%{http_code}")
        
        HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
        BODY=$(echo "$RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
        
        echo "å“åº”çŠ¶æ€ç : $HTTP_CODE"
        echo "å“åº”å†…å®¹: $BODY"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… API æµ‹è¯•é€šè¿‡"
        else
          echo "âŒ API æµ‹è¯•å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          exit 1
        fi
        
        echo "ðŸ§ª æµ‹è¯• OPTIONS é¢„æ£€è¯·æ±‚..."
        OPTIONS_CODE=$(curl -s -X OPTIONS http://localhost:3000/check_status \
          -H "Origin: http://localhost:3000" \
          -w "%{http_code}" -o /dev/null)
        
        if [ "$OPTIONS_CODE" = "200" ]; then
          echo "âœ… CORS é¢„æ£€è¯·æ±‚æµ‹è¯•é€šè¿‡"
        else
          echo "âŒ CORS é¢„æ£€è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : $OPTIONS_CODE"
          exit 1
        fi
        
        echo "ðŸ§ª æµ‹è¯• GET è¯·æ±‚ï¼ˆåº”è¯¥è¿”å›ž 405ï¼‰..."
        GET_CODE=$(curl -s -X GET http://localhost:3000/check_status \
          -w "%{http_code}" -o /dev/null)
        
        if [ "$GET_CODE" = "405" ]; then
          echo "âœ… GET è¯·æ±‚æ­£ç¡®è¿”å›ž 405"
        else
          echo "âš ï¸ GET è¯·æ±‚è¿”å›žçŠ¶æ€ç : $GET_CODEï¼ˆé¢„æœŸ 405ï¼‰"
        fi
        
        echo "ðŸ›‘ åœæ­¢æœåŠ¡å™¨..."
        kill $SERVER_PID || true
        wait $SERVER_PID 2>/dev/null || true
        
        echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
    
    - name: éªŒè¯é™æ€æ–‡ä»¶æœåŠ¡
      run: |
        echo "ðŸš€ å¯åŠ¨æœåŠ¡å™¨..."
        node server.js &
        SERVER_PID=$!
        sleep 2
        
        echo "ðŸ§ª æµ‹è¯• index.html..."
        if curl -f http://localhost:3000/ > /dev/null 2>&1; then
          echo "âœ… index.html å¯ä»¥è®¿é—®"
        else
          echo "âŒ index.html æ— æ³•è®¿é—®"
          kill $SERVER_PID || true
          exit 1
        fi
        
        echo "ðŸ›‘ åœæ­¢æœåŠ¡å™¨..."
        kill $SERVER_PID || true
        wait $SERVER_PID 2>/dev/null || true

