name: 完整测试和验证

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  full-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置 Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: 安装依赖
      run: npm ci
    
    - name: 代码质量检查
      run: |
        echo "📋 代码质量检查"
        echo "=================="
        echo ""
        echo "1. 检查 server.js 语法..."
        node -c server.js && echo "   ✅ server.js 语法正确"
        
        if [ -f "api/server.js" ]; then
          echo "2. 检查 api/server.js 语法..."
          node -c api/server.js && echo "   ✅ api/server.js 语法正确"
        fi
        
        echo "3. 检查 package.json..."
        node -e "require('./package.json')" && echo "   ✅ package.json 有效"
        
        echo ""
        echo "✅ 所有代码检查通过"
    
    - name: 功能测试
      run: |
        echo "🧪 功能测试"
        echo "============"
        echo ""
        
        echo "启动服务器..."
        node server.js &
        SERVER_PID=$!
        sleep 3
        
        echo ""
        echo "测试 1: 服务器启动..."
        if curl -f http://localhost:3000 > /dev/null 2>&1; then
          echo "   ✅ 服务器正常运行"
        else
          echo "   ❌ 服务器启动失败"
          kill $SERVER_PID || true
          exit 1
        fi
        
        echo ""
        echo "测试 2: POST /check_status API..."
        RESPONSE=$(curl -s -X POST http://localhost:3000/check_status \
          -H "Content-Type: application/json" \
          -d '{"url":"httpbin.org/status/200","protocol":"http"}')
        
        if echo "$RESPONSE" | grep -q '"status":200'; then
          echo "   ✅ API 返回正确状态码"
          echo "   响应: $RESPONSE"
        else
          echo "   ❌ API 测试失败"
          echo "   响应: $RESPONSE"
          kill $SERVER_PID || true
          exit 1
        fi
        
        echo ""
        echo "测试 3: CORS 支持..."
        CORS_HEADER=$(curl -s -X OPTIONS http://localhost:3000/check_status \
          -H "Origin: http://example.com" \
          -H "Access-Control-Request-Method: POST" \
          -i | grep -i "access-control-allow-origin")
        
        if [ -n "$CORS_HEADER" ]; then
          echo "   ✅ CORS 头设置正确"
          echo "   $CORS_HEADER"
        else
          echo "   ⚠️ CORS 头未找到"
        fi
        
        echo ""
        echo "测试 4: 静态文件服务..."
        if curl -f http://localhost:3000/index.html > /dev/null 2>&1; then
          echo "   ✅ 静态文件可以访问"
        else
          echo "   ❌ 静态文件无法访问"
          kill $SERVER_PID || true
          exit 1
        fi
        
        echo ""
        echo "测试 5: 错误请求处理..."
        ERROR_RESPONSE=$(curl -s -X GET http://localhost:3000/check_status)
        if echo "$ERROR_RESPONSE" | grep -q '"status":0'; then
          echo "   ✅ 错误请求正确处理"
        else
          echo "   ⚠️ 错误请求处理可能有问题"
        fi
        
        echo ""
        echo "停止服务器..."
        kill $SERVER_PID || true
        wait $SERVER_PID 2>/dev/null || true
        
        echo ""
        echo "✅ 所有功能测试通过"
    
    - name: 测试总结
      run: |
        echo ""
        echo "═══════════════════════════════════════"
        echo "🎉 所有测试完成"
        echo "═══════════════════════════════════════"
        echo ""
        echo "✅ 代码语法检查通过"
        echo "✅ 服务器启动测试通过"
        echo "✅ API 功能测试通过"
        echo "✅ CORS 支持正常"
        echo "✅ 静态文件服务正常"
        echo ""
        echo "📝 注意：GitHub Actions 用于 CI/CD 测试，"
        echo "   不能用于长期运行服务。如需部署服务，"
        echo "   请使用其他平台或自己的服务器。"
        echo ""

